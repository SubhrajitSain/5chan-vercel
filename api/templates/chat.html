{% extends "base.html" %}

{% block title %}Live Chat{% endblock %}

{% block content %}
    <h2>Live Chat</h2>
    <div class="chat-container">
        <div id="messages" class="chat-messages">
            </div>
        <div class="chat-input-area">
            {% if username %}
                <input type="text" id="message_input" placeholder="Type your message..." autocomplete="off">
                <button id="send_button">Send</button>
            {% else %}
                <p>Please <a href="{{ url_for('login') }}">log in</a> to send messages.</p>
                <input type="text" id="message_input" placeholder="Log in to chat..." disabled>
                <button id="send_button" disabled>Send</button>
            {% endif %}
        </div>
    </div>

    {# Include Socket.IO client library #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const messagesDiv = document.getElementById('messages');
            const messageInput = document.getElementById('message_input');
            const sendButton = document.getElementById('send_button');
            const username = "{{ username | e }}";

            function scrollToBottom() {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function addMessageToChat(data) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');

                if (data.error) {
                    messageElement.classList.add('system-message');
                    messageElement.innerHTML = `<strong>${data.username}:</strong> ${data.msg}`;
                } else if (data.username === username) {
                    messageElement.classList.add('my-message');
                    messageElement.innerHTML = `<span class="timestamp">${data.timestamp}</span> <strong>You:</strong> ${data.message}`;
                } else {
                    messageElement.innerHTML = `<span class="timestamp">${data.timestamp}</span> <strong>${data.username}:</strong> ${data.message}`;
                }
                messagesDiv.appendChild(messageElement);
                scrollToBottom();
            }

            socket.on('connect', function() {
                console.log('Connected to Socket.IO server!');
                addMessageToChat({
                    username: 'System',
                    msg: 'You connected to the chat.',
                    error: true
                });
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from Socket.IO server.');
                addMessageToChat({
                    username: 'System',
                    msg: 'You disconnected from the chat.',
                    error: true
                });
            });

            socket.on('receive_message', function(data) {
                addMessageToChat(data);
            });

            if (sendButton) {
                sendButton.onclick = function() {
                    const message = messageInput.value.trim();
                    if (message) {
                        socket.emit('send_message', { message: message });
                        messageInput.value = '';
                    }
                };

                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendButton.click();
                    }
                });
            }
        });
    </script>
{% endblock %}